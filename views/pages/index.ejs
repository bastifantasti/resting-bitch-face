<!DOCTYPE html>
<html>
<head>
  <% include ../partials/header.ejs %>
</head>

<body>

  <% include ../partials/nav.ejs %>

<div class="jumbotron text-center">
  <div class="container">
    <h2><a href="https://en.wikipedia.org/wiki/Resting_bitch_face" target="_blank">RESTING BITCH FACE</a></h2>
  </div>
</div>
<div class="container">
  <div class="alert alert-info text-center" role="alert">
    Für Kathi :)
  </div>
  <div id="output_error" class="hidden alert alert-danger text-center" role="alert">
    Nope. Sry. Reicht einfach nicht. Du bimst 1 Lauch.
  </div>

  <div id="output_success" class="hidden alert alert-success text-center" role="alert">
    LOL! Du bimst 1 Kathi vong Faceigkeit her.
  </div>
  <hr>
  <div class="row">
    <div class="col-xs-3" id="txt_top1">
      Anger
    </div>
    <div class="col-xs-3" id="txt_top2">
      Fear
    </div>
    <div class="col-xs-3" id="txt_top3">
      Neutral
    </div>
    <div class="col-xs-3" id="txt_top4">
      Sadness
    </div>
  </div>
  <div class="row">
    <div class="col-xs-3" id="val_top1">

    </div>
    <div class="col-xs-3" id="val_top2">

    </div>
    <div class="col-xs-3" id="val_top3">

    </div>
    <div class="col-xs-3" id="val_top4">

    </div>
  </div>

  <div class="row">
    <div class="col-md-6">
      <video autoplay="true" id="videoElement">

      </video><br><p>
      <button class="btn button btn-large btn-primary" onclick="myclick()">make 1 Kathi Face</button></p>
      <script>
          var video = document.querySelector("#videoElement");

          navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia || navigator.oGetUserMedia;

          if (navigator.getUserMedia) {
              navigator.getUserMedia({video: true}, handleVideo, videoError);
          }

          function handleVideo(stream) {
              video.src = window.URL.createObjectURL(stream);
          }

          function videoError(e) {
              // do something
          }

          var canvas = document.createElement('canvas');
          canvas.width = 640;
          canvas.height = 480;
          var ctx = canvas.getContext('2d');
          //draw image to canvas. scale to target dimensions

          function makeblob(dataURL) {
              var BASE64_MARKER = ';base64,';
              if (dataURL.indexOf(BASE64_MARKER) == -1) {
                  var parts = dataURL.split(',');
                  var contentType = parts[0].split(':')[1];
                  var raw = decodeURIComponent(parts[1]);
                  return new Blob([raw], { type: contentType });
              }
              var parts = dataURL.split(BASE64_MARKER);
              var contentType = parts[0].split(':')[1];
              var raw = window.atob(parts[1]);
              var rawLength = raw.length;

              var uInt8Array = new Uint8Array(rawLength);

              for (var i = 0; i < rawLength; ++i) {
                  uInt8Array[i] = raw.charCodeAt(i);
              }

              return new Blob([uInt8Array], { type: contentType });
          }


          function compareSecondColumn(a, b) {
              if (a[1] === b[1]) {
                  return 0;
              }
              else {
                  return (a[1] < b[1]) ? -1 : 1;
              }
          }

          function myclick() {
              console.log("check");
              $('#output_error').addClass('hidden');
              $('#output_success').addClass('hidden');

              ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

              //convert to desired file format
              var dataURI = canvas.toDataURL('image/jpeg');
              var img = makeblob(dataURI);
              console.log(img);
              console.log('bäm');
              var params = {
                  // Request parameters
              };
//data:image/jpeg;base64,


              $.ajax({
                  // NOTE: You must use the same location in your REST call as you used to obtain your subscription keys.
                  //   For example, if you obtained your subscription keys from westcentralus, replace "westus" in the
                  //   URL below with "westcentralus".
                  url: "https://westus.api.cognitive.microsoft.com/emotion/v1.0/recognize?" + $.param(params),
                  beforeSend: function(xhrObj){
                      // Request headers
                      xhrObj.setRequestHeader("Content-Type","application/octet-stream");

                      // NOTE: Replace the "Ocp-Apim-Subscription-Key" value with a valid subscription key.
                      xhrObj.setRequestHeader("Ocp-Apim-Subscription-Key","69f18f512ee542a099897c13dc255245");
                  },
                  type: "POST",
                  cache: false,
                  processData:false,
                  // Request body
                  // data: '{"url": "https://lh3.googleusercontent.com/-TrvVsPUYHJ4/AAAAAAAAAAI/AAAAAAAAA_s/retRu4VhsIg/s640/photo.jpg"}',
                  data: img,
              })
                  .done(function(data) {
                      console.log(data[0].scores);
                      var score = data[0].scores;

                      var anger = parseFloat((score.anger*100).toFixed(2));
                      var fear = parseFloat((score.fear*100).toFixed(2));
                      var neutral = parseFloat((score.neutral*100).toFixed(2));
                      var sadness = parseFloat((score.sadness*100).toFixed(2));
                      var contempt = parseFloat((score.contempt*100).toFixed(2));
                      var disgust = parseFloat((score.disgust*100).toFixed(2));
                      var happiness = parseFloat((score.happiness*100).toFixed(2));
                      var surprise = parseFloat((score.surprise*100).toFixed(2));
                      if(anger > 50 || disgust > 20 || contempt > 20 || sadness > 30){
                          $('#output_success').removeClass('hidden');
                      }else{
                          $('#output_error').removeClass('hidden');
                      }

                      var a = [['anger', anger], ['fear', fear], ['neutral', neutral],['sadness', sadness],
                          ['contempt', contempt],['disgust', disgust],['happiness', happiness],['surprise', surprise]];

                      a.sort(compareSecondColumn);


                      console.log(a);



                      $('#txt_top1').text(a[7][0]);
                      $('#txt_top2').text(a[6][0]);
                      $('#txt_top3').text(a[5][0]);
                      $('#txt_top4').text(a[4][0]);

                      $('#val_top1').text(a[7][1]);
                      $('#val_top2').text(a[6][1]);
                      $('#val_top3').text(a[5][1]);
                      $('#val_top4').text(a[4][1]);

                  })
                  .fail(function() {
                      //alert("error");
                  });
          }
      </script>


    </div>
  </div> <!-- row -->
 </div>

</body>
</html>
